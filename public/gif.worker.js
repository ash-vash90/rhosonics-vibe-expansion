// gif.worker.js - Web Worker for gif.js
// This worker handles the heavy lifting of GIF encoding in the background

(function(b){function a(b,d){if({}.hasOwnProperty.call(a.cache,b))return a.cache[b];var e=a.resolve(b);if(!e)throw new Error('Failed to resolve module '+b);var c={id:b,require:a,filename:b,exports:{},loaded:!1,parent:d,children:[]};d&&d.children.push(c);var f=b.slice(0,b.lastIndexOf('/')+1);return a.cache[b]=c.exports,e.call(c.exports,c,c.exports,f,b),c.loaded=!0,a.cache[b]=c.exports}a.modules={},a.cache={},a.resolve=function(b){return{}.hasOwnProperty.call(a.modules,b)?a.modules[b]:void 0},a.define=function(b,c){a.modules[b]=c},a.define('/gif.worker.coffee',function(d,e,f,g){var c,b;b=a('/GIFEncoder.js',d),c=function(a){var c,e,d;return c=new b(a.width,a.height),a.index===0?c.writeHeader():c.firstFrame=!1,c.setTransparent(a.transparent),c.setDispose(a.dispose),c.setRepeat(a.repeat),c.setDelay(a.delay),c.setQuality(a.quality),c.setDither(a.dither),c.setGlobalPalette(a.globalPalette),c.addFrame(a.data),a.last&&c.finish(),d=c.stream(),a.data=d.pages,a.cursor=d.cursor,a.pageSize=d.constructor.pageSize,a.canTransfer?(e=function(c){for(var b=0,d=a.data.length;b<d;++b)c.push(a.data[b].buffer);return c}([]),self.postMessage(a,e)):self.postMessage(a)},self.onmessage=function(a){return c(a.data)}}),a.define('/GIFEncoder.js',function(e,h,i,j){var c=a('/TypedNeuQuant.js',e),b=a('/LZWEncoder.js',e),g=a('/ByteArray.js',e);function d(){this.page=-1,this.pages=[],this.newPage()}d.pageSize=4096,d.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(d.pageSize),this.cursor=0},d.prototype.getData=function(){var a='';for(var b=0;b<this.pages.length;b++)for(var c=0;c<d.pageSize;c++)a+=String.fromCharCode(this.pages[b][c]);return a},d.prototype.writeByte=function(a){this.cursor>=d.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=a},d.prototype.writeUTFBytes=function(a){for(var c=a.length,b=0;b<c;b++)this.writeByte(a.charCodeAt(b))},d.prototype.writeBytes=function(a,b,c){for(var d=c||a.length,e=b||0;e<d;e++)this.writeByte(a[e])};function f(){this.width=null,this.height=null,this.transparent=null,this.transIndex=0,this.repeat=-1,this.delay=0,this.image=null,this.pixels=null,this.indexedPixels=null,this.colorDepth=null,this.colorTab=null,this.neuQuant=null,this.usedEntry=new Array,this.palSize=7,this.dispose=-1,this.firstFrame=!0,this.sample=10,this.dither=!1,this.globalPalette=!1,this.out=new d}f.prototype.setDelay=function(a){this.delay=Math.round(a/10)},f.prototype.setDispose=function(a){a>=0&&(this.dispose=a)},f.prototype.setRepeat=function(a){this.repeat=a},f.prototype.setTransparent=function(a){this.transparent=a},f.prototype.addFrame=function(a){this.image=a,this.colorTab=this.globalPalette&&this.globalPalette.slice?this.globalPalette:null,this.getImagePixels(),this.analyzePixels(),this.globalPalette===!0&&(this.globalPalette=this.colorTab),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.globalPalette||this.writePalette(),this.writePixels(),this.firstFrame=!1},f.prototype.finish=function(){this.out.writeByte(59)},f.prototype.setQuality=function(a){a<1&&(a=1),this.sample=a},f.prototype.setDither=function(a){a===!0&&(a='FloydSteinberg'),this.dither=a},f.prototype.setGlobalPalette=function(a){this.globalPalette=a},f.prototype.getGlobalPalette=function(){return this.globalPalette&&this.globalPalette.slice&&this.globalPalette.slice(0)||this.globalPalette},f.prototype.writeHeader=function(){this.out.writeUTFBytes('GIF89a')},f.prototype.analyzePixels=function(){if(!this.colorTab){this.neuQuant=new c(this.pixels,this.sample),this.neuQuant.buildColormap(),this.colorTab=this.neuQuant.getColormap()}this.indexedPixels=this.dither?this.ditherPixels(this.dither.replace('-serpentine',''),this.dither.match(/-serpentine/)!==null):this.quantizePixels(),this.pixels=null,this.colorDepth=8,this.palSize=7,this.transparent!==null&&(this.transIndex=this.findClosest(this.transparent,!0))},f.prototype.quantizePixels=function(){var b=this.pixels.length/3,a=new Uint8Array(b),c=0;for(var d=0;d<b;d++){var e=this.neuQuant.lookupRGB(this.pixels[c++]&255,this.pixels[c++]&255,this.pixels[c++]&255);a[d]=e}return a},f.prototype.ditherPixels=function(f,g){var d={FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]]},c=d[f],e=g?-1:1,a=this.pixels.length/3,h=this.width,i=new Uint8Array(a),b=new Int32Array(this.pixels);for(var k=0;k<a;k++){var j=k*3,l=b[j],m=b[j+1],n=b[j+2];l>255?l=255:l<0&&(l=0),m>255?m=255:m<0&&(m=0),n>255?n=255:n<0&&(n=0);var o=this.neuQuant.lookupRGB(l,m,n);i[k]=o;var p=this.colorTab[o*3],q=this.colorTab[o*3+1],r=this.colorTab[o*3+2],s=l-p,t=m-q,u=n-r;for(var v=g&&k%h%2===1,w=0;w<c.length;w++){var x=v?-c[w][1]:c[w][1],y=c[w][2];if(x+k%h>=0&&x+k%h<h&&y+Math.floor(k/h)<Math.floor(a/h)){var z=(y*h+x+k)*3;b[z]+=s*c[w][0],b[z+1]+=t*c[w][0],b[z+2]+=u*c[w][0]}}e=-e}return i},f.prototype.findClosest=function(e,f){if(this.colorTab===null)return-1;var k=(e&16711680)>>16,l=(e&65280)>>8,m=e&255,c=0,d=16777216,j=this.colorTab.length;for(var a=0,b=0;a<j;b++){var g=k-(this.colorTab[a++]&255),h=l-(this.colorTab[a++]&255),i=m-(this.colorTab[a++]&255),n=g*g+h*h+i*i;(!f||this.usedEntry[b])&&n<d&&(d=n,c=b)}return c},f.prototype.getImagePixels=function(){var a=this.width,g=this.height;this.pixels=new Uint8Array(a*g*3);var b=this.image,c=0;for(var d=0;d<g;d++)for(var e=0;e<a;e++){var f=d*a*4+e*4;this.pixels[c++]=b[f],this.pixels[c++]=b[f+1],this.pixels[c++]=b[f+2]}},f.prototype.writeLSD=function(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)},f.prototype.writeNetscapeExt=function(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.out.writeUTFBytes('NETSCAPE2.0'),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)},f.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);var a=768-this.colorTab.length;for(var b=0;b<a;b++)this.out.writeByte(0)},f.prototype.writeShort=function(a){this.out.writeByte(a&255),this.out.writeByte(a>>8&255)},f.prototype.writePixels=function(){var a=new b(this.width,this.height,this.indexedPixels,this.colorDepth);a.encode(this.out)},f.prototype.writeGraphicCtrlExt=function(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);var b,a;this.transparent===null?(b=0,a=0):(b=1,a=2),this.dispose>=0&&(a=this.dispose&7),a<<=2,this.out.writeByte(0|a|0|b),this.writeShort(this.delay),this.out.writeByte(this.transIndex),this.out.writeByte(0)},f.prototype.writeImageDesc=function(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame||this.globalPalette?this.out.writeByte(0):this.out.writeByte(128|this.palSize)},f.prototype.stream=function(){return this.out},e.exports=f}),a.define('/LZWEncoder.js',function(d,e,f,g){function c(g,h,i,j){var r=32767,o=12,d=5003,l=new Uint8Array(256),t=new Int32Array(d),u=new Int32Array(d),k,q,n,p,m,e,s=0,b,c,a;this.encode=function(d){d.writeByte(i),q=g*h,n=0,p=i+1,m=p+1,e=p+2,b=!0,this.compress(i+1,d),d.writeByte(0)};function f(){for(var a=0;a<d;++a)t[a]=-1}function v(a,b){c=a,s=0,w(b)}function w(e){var b=0,g=c;while(g-- >0&&(b=y(a,b))!=0)e.writeByte(b);return b}function x(b){a>>=b,c-=b}function y(b,d){while(c<d){var e=l[s++];a|=e<<c,c+=8}var f=a&(1<<d)-1;return x(d),f}this.compress=function(n,g){var j,l,c,x,p,d,w,i=1<<n,h=Math.ceil(Math.log(i)/Math.LN2);for(a=0,c=n,s=0,k=i,q=q<0?0:q,m=k+2,e=k+1,b=!0,w=-1,p=h+1,x=(1<<p)-1,f(),v(p,g),j=0;j<q;){l=r,d=u[j];do t[d]==-1?(l=d,d=-1):this.p[j]==t[d]?(l=u[d],d=-1):(d=t[d]<j?t[d]+r:t[d]-j);while(d>=0);if(w==-1)v(p,g),w=j;else if(l<r){if(m<1<<o)t[l]=m++,u[l]=j;m>x&&p<o&&(p++,x=(1<<p)-1)}else v(p,g),m=k+2,x=(1<<(p=h+1))-1,b=!0,f();j++}w!=-1&&v(p,g),v(e,g)};this.p=new Uint8Array(q)}d.exports=c}),a.define('/TypedNeuQuant.js',function(d,f,g,h){var b=256,c=100,e=function(a,y){var t=[],d=new Int32Array(256),k=new Int32Array(b),l=new Int32Array(b),m=new Int32Array(b),n=new Int32Array(b>>3);function v(){for(var a=0;a<b;a++)k[a]=(a<<12)/b;for(a=0;a<b;a++){t[a]={},t[a].b=(a<<12)/b|0,t[a].g=t[a].b,t[a].r=t[a].b,d[a]=4096/b|0,l[a]=1<<18,m[a]=0}}function w(){var n=a.length,p=1,g=30+(y-1)/3|0,r=n/(3*c)|0,o=r/c|0,q=1<<18,f=b>>3,e=f*6|0;if(o<=0)o=1;v();for(var h=0;h<o;){for(var i=0,d=0;i<r;){var s=(a[d]<<4)-t[k[0]].b,u=(a[d+1]<<4)-t[k[0]].g,w=(a[d+2]<<4)-t[k[0]].r;t[k[0]].b+=s*p/q|0,t[k[0]].g+=u*p/q|0,t[k[0]].r+=w*p/q|0;for(var v=1;v<f;v++){var m=k[v],x=q-l[m];t[m].b+=(s*x)/q/b|0,t[m].g+=(u*x)/q/b|0,t[m].r+=(w*x)/q/b|0}d+=3,i++;if(i%o===0){p-=p/g|0,q-=q/(30+1)|0;for(v=0;v<f;v++)l[k[v]]-=l[k[v]]/e|0}}for(v=0;v<b-1;v++)for(var y=v+1;y<b;y++)if(l[k[v]]<l[k[y]]){var z=k[v];k[v]=k[y],k[y]=z}h++}}function x(){for(var a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=0;r<b;r++){h=t[r].b,i=t[r].g,j=t[r].r,a=2147483647,c=a;for(s=0;s<b;s++){l=t[s].b-h,l<0&&(l=-l),l<a&&(m=t[s].g-i,m<0&&(m=-m),l+=m,l<a&&(n=t[s].r-j,n<0&&(n=-n),l+=n,l<a&&(a=l,d=s)))}if(d!==r){k=t[d],l=t[r].b,m=t[r].g,n=t[r].r,t[r].b=k.b,t[r].g=k.g,t[r].r=k.r,k.b=l,k.g=m,k.r=n}}for(s=0;s<b;s++){o=(t[s].b+8)>>4,p=(t[s].g+8)>>4,q=(t[s].r+8)>>4,n[s*3]=o>255?255:o<0?0:o,n[s*3+1]=p>255?255:p<0?0:p,n[s*3+2]=q>255?255:q<0?0:q}}var n=new Uint8Array(b*3),s;this.buildColormap=function(){w(),x()},this.getColormap=function(){return n},this.lookupRGB=function(e,f,g){for(var a=2147483647,b=-1,c,d=0;d<256;d++){c=n[d*3]-e,c<0&&(c=-c);var h=n[d*3+1]-f;h<0&&(h=-h),c+=h,h=n[d*3+2]-g,h<0&&(h=-h),c+=h,c<a&&(a=c,b=d)}return b}};d.exports=e}),a.define('/ByteArray.js',function(a,c,d,e){function b(){this.data=[]}b.prototype.getData=function(){return new Uint8Array(this.data)},b.prototype.writeByte=function(a){this.data.push(a)},b.prototype.writeUTFBytes=function(b){for(var c=b.length,a=0;a<c;a++)this.writeByte(b.charCodeAt(a))},b.prototype.writeBytes=function(b,c,d){for(var e=d||b.length,a=c||0;a<e;a++)this.writeByte(b[a])},a.exports=b});var c=a('/gif.worker.coffee')}.call(this));